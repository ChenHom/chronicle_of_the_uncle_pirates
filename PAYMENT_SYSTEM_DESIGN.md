# 收費管理系統 - 系統架構設計

## 📋 專案概覽

**系統名稱**: 海盜大叔收費管理系統  
**整合專案**: 海盜大叔航海誌 (Chronicle of the Uncle Pirates)  
**主要目標**: 為團隊活動提供便利的收費管理和追蹤功能  
**技術架構**: Next.js 15 + Google Sheets 資料庫 + LINE Login 認證  

## 🎯 核心需求

### 功能需求
1. **活動管理**: 建立活動、設定收費金額、管理參與成員
2. **收費追蹤**: 即時更新繳費狀態、記錄收費金額和時間
3. **身份認證**: LINE Login 整合，自動驗證授權成員
4. **權限控制**: 管理員、收費員、一般成員三級權限
5. **資料整合**: 自動產生收支明細，整合現有財務系統
6. **行動優先**: 手機友善的操作介面，支援觸控操作

### 非功能需求
1. **效能**: 利用現有快取策略，5分鐘內資料同步
2. **安全性**: LINE OAuth 2.0 認證 + 角色權限控制
3. **可用性**: 24/7 可用，依賴 Vercel + Google Sheets 穩定性
4. **擴展性**: 基於 Google Sheets，易於調整欄位和功能
5. **維護性**: 無需資料庫維護，Google Sheets 自動備份

## 🏗 系統架構圖

```
┌─────────────────────────────────────────────────────────┐
│                     使用者介面層                          │
├─────────────────┬─────────────────┬─────────────────────┤
│   管理員介面      │    收費員介面     │    成員檢視介面      │
│  - 活動管理      │  - 收費操作      │  - 個人繳費記錄     │
│  - 成員審核      │  - 狀態更新      │  - 活動資訊        │
│  - 系統設定      │  - 進度檢視      │  - 繳費提醒        │
└─────────────────┴─────────────────┴─────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                     應用程式層                           │
├─────────────────┬─────────────────┬─────────────────────┤
│   Next.js App   │   API Routes    │   NextAuth.js       │
│  - 頁面路由      │  - CRUD API     │  - LINE Login       │
│  - 組件管理      │  - 資料驗證     │  - Session 管理     │
│  - 狀態管理      │  - 錯誤處理     │  - 權限檢查        │
└─────────────────┴─────────────────┴─────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                     服務層                              │
├─────────────────┬─────────────────┬─────────────────────┤
│  Google Sheets  │   快取層        │   LINE API          │
│  - 資料 CRUD    │  - 內存快取     │  - 使用者資訊       │
│  - 工作表管理   │  - ISR 快取     │  - OAuth 認證       │
│  - API 整合     │  - 即時更新     │  - Profile 取得     │
└─────────────────┴─────────────────┴─────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                     資料層                              │
├─────────────────┬─────────────────┬─────────────────────┤
│  Google Sheets  │   Vercel 儲存   │   瀏覽器儲存        │
│  - 主要資料庫   │  - Session 資料 │  - 快取資料        │
│  - 自動備份     │  - 暫存檔案     │  - 使用者偏好      │
│  - 版本控制     │  - 日誌記錄     │  - 離線資料        │
└─────────────────┴─────────────────┴─────────────────────┘
```

## 🔐 認證與權限架構

### LINE Login 整合流程
```
使用者點擊登入
       ↓
重導向到 LINE OAuth
       ↓
使用者授權並返回
       ↓
取得 LINE Profile (UserID, DisplayName, Picture)
       ↓
檢查「可註冊人員列表」
       ↓
┌─ 找到匹配 ────→ 自動建立帳戶 ────→ 設定權限 ────→ 登入成功
│
├─ 多個可能匹配 ──→ 使用者選擇身份 ──→ 確認後建立帳戶 ──→ 登入成功
│
├─ 無法匹配 ────→ 建立待審核申請 ──→ 等待管理員審核 ──→ 審核後登入
│
└─ 不在授權清單 ──→ 顯示拒絕訊息 ──→ 聯絡管理員 ──→ 加入清單後重試
```

### 權限控制矩陣
| 功能 | 管理員 | 收費員 | 一般成員 |
|-----|-------|-------|---------|
| 建立活動 | ✅ | ❌ | ❌ |
| 編輯活動 | ✅ | ❌ | ❌ |
| 管理成員 | ✅ | ❌ | ❌ |
| 審核註冊 | ✅ | ❌ | ❌ |
| 收費操作 | ✅ | ✅ | ❌ |
| 檢視收費進度 | ✅ | ✅ | ✅ (限個人) |
| 檢視活動 | ✅ | ✅ | ✅ |
| 產生報表 | ✅ | ✅ | ❌ |
| 系統設定 | ✅ | ❌ | ❌ |

## 📊 資料流程設計

### 收費管理主要流程
```
管理員建立活動
       ↓
設定活動資訊 (名稱、日期、金額)
       ↓
選擇參與成員 (從已註冊成員清單)
       ↓
系統自動建立收費追蹤記錄
       ↓
收費員開始收費作業
       ↓
更新個別成員繳費狀態
       ↓
即時同步到 Google Sheets
       ↓
清除相關快取，更新前端顯示
       ↓
收費完成後批次產生交易記錄
       ↓
整合到現有財務系統
```

### 資料同步策略
```
寫入操作：
1. 使用者操作 → 即時寫入 Google Sheets
2. 清除相關快取
3. 回傳最新資料給前端
4. 觸發背景同步任務

讀取操作：
1. 檢查快取 (5分鐘有效期)
2. 快取命中 → 直接回傳
3. 快取未命中 → 讀取 Google Sheets
4. 更新快取 → 回傳資料

衝突處理：
1. 樂觀鎖定 (LastUpdated 時間戳)
2. 衝突檢測 → 提示使用者重新整理
3. 重要操作 → 強制即時讀取
```

## 🎨 使用者體驗設計

### 手機優先設計原則
1. **大觸控區域**: 按鈕至少 48px 高度
2. **清楚的視覺層次**: 色彩區分不同狀態
3. **即時反饋**: 操作後立即顯示結果
4. **簡化操作**: 最多 3 步完成主要任務
5. **離線支援**: 關鍵功能支援離線操作

### 頁面結構設計
```
/management/
├── dashboard           # 管理員總覽
├── events/
│   ├── index          # 活動列表
│   ├── create         # 建立活動
│   └── [id]/
│       ├── index      # 活動詳情
│       ├── members    # 成員管理
│       └── payment    # 收費管理
├── members/
│   ├── index          # 成員列表
│   ├── pending        # 待審核申請
│   └── authorized     # 可註冊清單
└── reports            # 報表統計

/collection/
├── events             # 可收費活動列表
└── [eventId]          # 收費操作頁面

/my/
├── profile            # 個人資料
├── events             # 參與活動
└── payments           # 繳費記錄
```

## ⚡ 效能優化策略

### 快取層級設計
```
Level 1: 瀏覽器快取
- Static assets (24小時)
- API responses (5分鐘)
- 使用者偏好設定

Level 2: 應用程式內存快取
- Google Sheets 回應 (5分鐘)
- 權限檢查結果 (10分鐘)
- 靜態清單資料 (15分鐘)

Level 3: Next.js ISR 快取
- 頁面靜態生成 (5分鐘)
- 動態路由快取 (10分鐘)
- API 路由快取 (依功能調整)
```

### 資料載入策略
```
關鍵資料 (即時):
- 使用者權限
- 收費狀態更新
- 重要通知

一般資料 (快取):
- 活動列表
- 成員清單
- 統計資料

背景更新:
- 歷史記錄
- 報表資料
- 統計分析
```

## 🛡️ 安全性設計

### 認證安全
```
1. LINE OAuth 2.0 認證
   - HTTPS 強制執行
   - CSRF 防護
   - State 參數驗證

2. Session 管理
   - JWT Token 簽署
   - 適當的過期時間
   - 自動刷新機制

3. 權限檢查
   - 每次 API 調用都驗證
   - 前端 + 後端雙重檢查
   - 敏感操作二次確認
```

### 資料安全
```
1. 輸入驗證
   - API 參數檢查
   - 資料格式驗證
   - SQL 注入防護 (雖然用 Sheets)

2. 輸出編碼
   - XSS 防護
   - HTML 編碼
   - 敏感資料遮罩

3. 存取控制
   - 基於角色的權限
   - 資料行級別控制
   - 操作日誌記錄
```

## 📈 監控與維護

### 系統監控指標
```
效能指標:
- API 回應時間
- 快取命中率
- Google Sheets API 配額使用

使用量指標:
- 活躍使用者數
- 功能使用頻率
- 錯誤發生率

業務指標:
- 收費完成率
- 平均收費時間
- 使用者滿意度
```

### 維護策略
```
定期維護:
- 清理過期資料
- 更新依賴套件
- 檢查 API 配額

故障處理:
- 自動錯誤報告
- 快速回復機制
- 備用方案準備

容量規劃:
- Google Sheets 大小限制
- API 調用頻率限制
- 使用者數量增長預測
```

## 🔮 未來擴展方向

### 短期擴展 (1-3個月)
- 推播通知整合
- Excel 匯出功能
- 進階統計圖表
- PWA 離線支援

### 中期擴展 (3-6個月)
- LINE Bot 整合
- 自動提醒功能
- 多重活動同時進行
- 財務預測分析

### 長期擴展 (6個月+)
- 多團隊支援
- 進階報表系統
- 外部系統整合
- 人工智能分析

---

**文件版本**: v1.0  
**建立日期**: 2025年8月17日  
**維護負責**: 開發團隊  
**審核狀態**: 待審核
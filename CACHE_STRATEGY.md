# 快取策略說明

本專案實作了多層快取機制，提升網站效能並減少 Google Sheets API 呼叫頻率。

## 📚 快取層級

### 1. 應用程式內存快取 (In-Memory Cache)
- **位置**: `src/lib/sheets.ts`
- **快取時間**: 5 分鐘
- **適用範圍**: Google Sheets API 回應資料
- **優點**: 極快的存取速度，減少 API 呼叫

```typescript
// 快取配置
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
```

### 2. Next.js ISR (增量靜態再生)
- **位置**: 各頁面的 `export const revalidate`
- **快取時間**: 
  - 首頁: 5 分鐘 (300 秒)
  - 財務頁面: 5 分鐘 (300 秒) - 財務資料更新頻繁
  - 相簿頁面: 10 分鐘 (600 秒) - 相簿更新較不頻繁

```typescript
// 頁面層級的快取設定
export const revalidate = 300; // 5 minutes
```

## 🔄 快取運作流程

### 首次請求
```
使用者訪問頁面
↓
Next.js 檢查 ISR 快取 (無資料)
↓
執行 Google Sheets API 函數
↓
檢查內存快取 (無資料)
↓
呼叫 Google Sheets API
↓
儲存到內存快取
↓
回傳資料並產生靜態頁面
↓
儲存 ISR 快取
```

### 後續請求 (快取未過期)
```
使用者訪問頁面
↓
Next.js 回傳 ISR 快取頁面 ⚡ (極快)
```

### 後續請求 (ISR 快取過期，但內存快取未過期)
```
使用者訪問頁面
↓
Next.js 檢查 ISR 快取 (已過期)
↓
執行 Google Sheets API 函數
↓
檢查內存快取 (有資料) ✅
↓
直接從快取回傳資料 ⚡
↓
重新產生靜態頁面
↓
更新 ISR 快取
```

## 📊 效能優化效果

### Google Sheets API 呼叫頻率
- **沒有快取**: 每次頁面訪問都呼叫 API
- **有快取**: 最多每 5 分鐘呼叫一次 API

### 頁面載入速度
- **冷啟動** (無快取): 1-3 秒 (取決於 API 回應時間)
- **熱快取** (ISR 快取命中): <100ms ⚡
- **溫快取** (內存快取命中): <500ms

## 🛠 開發工具

### 快取狀態指示器
在開發環境中，右下角會顯示快取狀態按鈕：
- 🟢 綠色: 有快取資料
- 🔴 紅色: 沒有快取資料

點擊可查看：
- 快取鍵值
- 資料存在時間
- 剩餘快取時間

### 快取 API 端點
**僅在開發環境可用**:
```bash
# 查看快取狀態
GET /api/cache-status

# 清除所有快取
DELETE /api/cache-status

# 清除特定快取
DELETE /api/cache-status?key=albums
```

## ⚙️ 快取配置調整

### 修改快取時間
```typescript
// src/lib/sheets.ts - 內存快取
const CACHE_DURATION = 5 * 60 * 1000; // 改成想要的毫秒數

// src/app/page.tsx - ISR 快取
export const revalidate = 300; // 改成想要的秒數
```

### 適合的快取時間設定

| 資料類型 | 建議內存快取 | 建議 ISR 快取 | 理由 |
|---------|-------------|--------------|------|
| 財務資料 | 3-5 分鐘 | 5 分鐘 | 更新頻繁，需要相對即時 |
| 相簿資料 | 10-15 分鐘 | 10 分鐘 | 更新較少，可以較長快取 |
| 統計資料 | 5-10 分鐘 | 5 分鐘 | 基於其他資料計算 |

## 🚨 注意事項

1. **內存快取限制**: 重啟伺服器會清除所有內存快取
2. **Vercel 函數限制**: Vercel Functions 有執行時間和內存限制
3. **API 配額**: Google Sheets API 有每日請求限制
4. **一致性**: 快取可能導致資料暫時不一致，需要在效能和即時性間平衡

## 🔧 疑難排解

### 快取未生效
1. 檢查環境變數是否正確設定
2. 查看 Vercel 函數日誌
3. 使用開發工具查看快取狀態

### 資料更新延遲
1. 確認快取時間設定是否合適
2. 可以手動清除快取強制更新
3. 考慮縮短快取時間

### 效能問題
1. 檢查 Google Sheets API 回應時間
2. 考慮調整快取策略
3. 監控 API 呼叫頻率

---

這個快取策略在保持資料相對即時的同時，大幅提升了網站效能和使用者體驗。